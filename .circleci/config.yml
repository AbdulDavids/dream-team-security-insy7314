version: 2.1

# CircleCI configuration for Next.js application
# This pipeline runs install, quality checks, and build stages

orbs:
  node: circleci/node@5

jobs:
  install:
    executor:
      name: node/default
      tag: '20'
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-version: 'v1'
      - persist_to_workspace:
          root: ~/project
          paths:
            - node_modules
            - package-lock.json

  quality:
    executor:
      name: node/default
      tag: '20'
    steps:
      - checkout
      - attach_workspace:
          at: ~/project
      - run:
          name: Run ESLint (if configured)
          command: |
            if npm run | grep -q "lint"; then
              npm run lint
            else
              echo "No lint script found, skipping..."
            fi
      - run:
          name: Type Check
          command: |
            if [ -f "tsconfig.json" ]; then
              npx tsc --noEmit || echo "TypeScript check skipped if no types configured"
            else
              echo "No tsconfig.json found, skipping type check"
            fi
      - run:
          name: Security Audit
          command: npm audit --audit-level=moderate || true

  build:
    executor:
      name: node/default
      tag: '20'
    environment:
      # Set NODE_ENV to production for optimized build
      NODE_ENV: production
      # Note: The following environment variables should be configured in CircleCI project settings:
      # - ATLAS_URI: MongoDB Atlas connection string (required for app runtime)
      # - SESSION_SECRET: Session encryption secret (required for app runtime)
      # - EMPLOYEE_DEFAULT_PASSWORD: Default password for seeded employee (optional, only needed for seeding)
      # These are typically not needed at build time but should be set for completeness
    steps:
      - checkout
      - attach_workspace:
          at: ~/project
      - run:
          name: Build Application
          command: npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - .next

workflows:
  version: 2
  install_quality_build:
    jobs:
      - install
      - quality:
          requires:
            - install
      - build:
          requires:
            - install
            - quality
